
&НаСервере
Процедура СкорректироватьНаСервере()
	
	// ===== ПОДГОТОВКА ДАННЫХ ДЛЯ КОРРЕКТИРОВКИ =====
	// Устанавливаем дату корректировки на конец дня документа
	// Это важно для получения корректных остатков на конец периода
	ДатаКорректировки = КонецДня(Объект.Дата);
	
	// Блокируем регистр бухгалтерии от изменений на время операции
	// Это предотвращает конфликты при параллельной корректировке задолженностей
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрБухгалтерии.Управленческий");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.УстановитьЗначение("Счет", ПланыСчетов.Управленческий.Покупатели);
	Блокировка.Заблокировать();
	
	// ===== ЗАПРОС ДЛЯ ВЫЧИСЛЕНИЯ КУРСОВЫХ РАЗНИЦ =====
	// Получаем все задолженности покупателей и рассчитываем курсовые разницы
	// Сравниваем сумму в валюте (пересчитанную по курсу) с суммой в рублях
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	УправленческийОстатки.Субконто1 КАК Контрагент,
		|	УправленческийОстатки.Субконто2 КАК Договор,
		|	УправленческийОстатки.СуммаВалОстаток КАК СуммаВалОстаток,
		|	УправленческийОстатки.СуммаОстаток КАК СуммаОстаток,
		|	УправленческийОстатки.Субконто2.Валюта КАК Валюта
		|ПОМЕСТИТЬ втЗадолженности
		|ИЗ
		|	РегистрБухгалтерии.Управленческий.Остатки(&Период, Счет = &Счет, &ВидыСубконто, ) КАК УправленческийОстатки
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Валюта
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втЗадолженности.Контрагент КАК Контрагент,
		|	втЗадолженности.Договор КАК Договор,
		|	втЗадолженности.СуммаВалОстаток КАК СуммаВалОстаток,
		|	втЗадолженности.Валюта КАК Валюта,
		|	втЗадолженности.СуммаВалОстаток * ВЫБОР
		|		КОГДА КурсыВалютСрезПоследних.Валюта <> ЗНАЧЕНИЕ(Справочник.Валюты.РоссийскийРубль)
		|			ТОГДА ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 0)
		|		ИНАЧЕ 1
		|	КОНЕЦ - втЗадолженности.СуммаОстаток КАК КурсоваяРазница
		|ИЗ
		|	втЗадолженности КАК втЗадолженности
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
		|				&Период,
		|				Валюта В
		|					(ВЫБРАТЬ
		|						втЗадолженности.Валюта КАК Валюта
		|					ИЗ
		|						втЗадолженности КАК втЗадолженности)) КАК КурсыВалютСрезПоследних
		|		ПО втЗадолженности.Валюта = КурсыВалютСрезПоследних.Валюта
		|ГДЕ
		|	втЗадолженности.СуммаВалОстаток * ВЫБОР
		|			КОГДА КурсыВалютСрезПоследних.Валюта <> ЗНАЧЕНИЕ(Справочник.Валюты.РоссийскийРубль)
		|				ТОГДА ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 0)
		|			ИНАЧЕ 1
		|		КОНЕЦ - втЗадолженности.СуммаОстаток <> 0";
	
	// Формируем массив видов субконто для фильтрации в запросе
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Покупатели);
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.Договоры);
	
	Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
	Запрос.УстановитьПараметр("Период", ДатаКорректировки + 1);
	Запрос.УстановитьПараметр("Счет", ПланыСчетов.Управленческий.Покупатели);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	// Если нет данных для корректировки (все курсовые разницы = 0), выходим
	Если РезультатЗапроса.Пустой() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Нет данных для формирования движений!";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	// ===== ФОРМИРОВАНИЕ ДОКУМЕНТА КОРРЕКТИРОВКИ =====
	// Начинаем транзакцию для атомарности операции
	НачатьТранзакцию();
	
	Попытка
		
		// Создаем новый документ "Операция" для регистрации корректировок
		НовыйДокумент = Документы.Операция.СоздатьДокумент();
		НовыйДокумент.Дата = ДатаКорректировки;
		НовыйДокумент.Записать();
		
		// Создаем набор записей для регистра бухгалтерии
		НаборЗаписей = РегистрыБухгалтерии.Управленческий.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(НовыйДокумент.Ссылка);
		
		// ===== ОБРАБОТКА РЕЗУЛЬТАТОВ ЗАПРОСА =====
   	 	// Для каждой курсовой разницы формируем соответствующее движение
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.КурсоваяРазница > 0 Тогда
				// Если курсовая разница положительная:
        			// Это означает, что рублевый эквивалент вырос (курс валюты вырос)
       			// Увеличиваем задолженность покупателя и отражаем убыток
				Движение = НаборЗаписей.Добавить();
				Движение.Период = ДатаКорректировки;
				Движение.СчетДт = ПланыСчетов.Управленческий.Покупатели;
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Покупатели] = Выборка.Контрагент;
				Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Выборка.Договор;
				Движение.СчетКт = ПланыСчетов.Управленческий.ПрибылиУбытки;
				Движение.Сумма = Выборка.КурсоваяРазница;
				// Если курсовая разница отрицательная:
			     // Рублевый эквивалент уменьшился (курс валюты упал)
			     // Уменьшаем задолженность покупателя и отражаем прибыль
			Иначе
				Движение = НаборЗаписей.Добавить();
				Движение.Период = ДатаКорректировки;
				Движение.СчетДт = ПланыСчетов.Управленческий.ПрибылиУбытки;
				Движение.СчетКт = ПланыСчетов.Управленческий.Покупатели;
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Покупатели] = Выборка.Контрагент;
				Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Договоры] = Выборка.Договор;
				Движение.Сумма = -Выборка.КурсоваяРазница;
			КонецЕсли;
			
		КонецЦикла;
		
		 // Записываем все движения одним вызовом
		НаборЗаписей.Записать();
		
		// Уведомляем пользователя об успешном завершении
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Корректировка прошла успешно!";
		Сообщение.Сообщить();
		
		// Фиксируем транзакцию - все изменения сохраняются
		ЗафиксироватьТранзакцию();
	Исключение 
		// При ошибке откатываем все изменения транзакции
		ОтменитьТранзакцию();
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Сообщение.Сообщить();
	КонецПопытки;
КонецПроцедуры

&НаКлиенте
Процедура Скорректировать(Команда)
	// Проверяем заполнение обязательных полей перед выполнением корректировки
	Если ПроверитьЗаполнение() Тогда
		СкорректироватьНаСервере(); // Вызываем серверную процедуру
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// При создании документа устанавливаем текущую дату
	Объект.Дата = НачалоДня(ТекущаяДата());
КонецПроцедуры
