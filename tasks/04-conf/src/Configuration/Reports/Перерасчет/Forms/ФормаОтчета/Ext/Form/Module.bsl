
// ===== СЕРВЕРНАЯ ПРОЦЕДУРА ПЕРЕРАСЧЕТА (БЕЗ КОНТЕКСТА ВЫПОЛНЕНИЯ) =====
// Процедура вызывается на сервере без контекста для массового перерасчета
// дополнительных начислений по данным из регистра перерасчетов
&НаСервереБезКонтекста
Процедура ПерерассчитатьНаСервере()
	
	// ===== ПОЛУЧЕНИЕ ДАННЫХ ДЛЯ ПЕРЕРАСЧЕТА =====
	// Запрос собирает все записи из регистра перерасчетов,
	// сгруппированные по документу-регистратору (чтобы пересчитывать документы целиком)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Перерасчет.ОбъектПерерасчета КАК Регистратор,
		|	Перерасчет.Сотрудник КАК Сотрудник,
		|	Перерасчет.Подразделение КАК Подразделение
		|ИЗ
		|	РегистрРасчета.ДополнительныеНачисления.Перерасчет КАК Перерасчет
		|ИТОГИ ПО
		|	Регистратор";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	// ===== ОБРАБОТКА СГРУППИРОВАННЫХ ДАННЫХ =====
	// Группировка позволяет пересчитывать один документ за один раз,
	// что эффективнее, чем построчный перерасчет
	ВыборкаРегистратор = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	// Создаем таблицу для передачи фильтра в расчетную функцию
	// Фильтр содержит конкретных сотрудников и подразделения для каждого документа
	ДопОтбор = Новый ТаблицаЗначений;
	ДопОтбор.Колонки.Добавить("Сотрудник", Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	ДопОтбор.Колонки.Добавить("Подразделение", Новый ОписаниеТипов("СправочникСсылка.Подразделения"));
	
	// ===== ПЕРЕРАСЧЕТ КАЖДОГО ДОКУМЕНТА ОТДЕЛЬНО =====
	// Для каждого документа, требующего перерасчета:
	// 1. Формируем фильтр по сотрудникам и подразделениям
	// 2. Загружаем существующие записи
	// 3. Вызываем перерасчет только для нужных записей
	Пока ВыборкаРегистратор.Следующий() Цикл
		ВыборкаДетальныеЗаписи = ВыборкаРегистратор.Выбрать();
		
		 // Очищаем таблицу фильтра для нового документа
		ДопОтбор.Очистить();
		
		 // Заполняем фильтр конкретными строками, требующими перерасчета
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			НоваяСтрока = ДопОтбор.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаДетальныеЗаписи);
		КонецЦикла;
		
		// Создаем набор записей для конкретного документа
        	// и загружаем текущие данные из регистра расчета
		НаборЗаписей = РегистрыРасчета.ДополнительныеНачисления.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаРегистратор.Регистратор);
		НаборЗаписей.Прочитать();
		
		// Вызываем расчетную функцию только для измененных записей
        	// ДопОтбор ограничивает перерасчет только нужными сотрудниками и подразделениями
		ЗаписьРасчетов.ЗаписатьДополнительныеНачисления(НаборЗаписей, ВыборкаРегистратор.Регистратор, ДопОтбор);
	КонецЦикла;
		
КонецПроцедуры

&НаКлиенте
Процедура Перерассчитать(Команда)
	 // 1. Выполняем перерасчет на сервере
	ПерерассчитатьНаСервере(); 
	// 2. Обновляем данные отчета, чтобы показать актуальные результаты
	СкомпоноватьРезультат();
КонецПроцедуры
