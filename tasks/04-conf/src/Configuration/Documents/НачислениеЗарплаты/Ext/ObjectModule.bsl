
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// ===== РЕГИСТРАЦИЯ ОСНОВНЫХ НАЧИСЛЕНИЙ =====
	// Основные начисления (оклад) регистрируются с периодом действия, 
	// соответствующим фактически отработанным дням в месяце
	ПериодРегистрации = НачалоМесяца(Дата);
	
	Движения.ОсновныеНачисления.Записывать = Истина;
	Для Каждого Строка Из ОсновныеНачисления Цикл
		// Копируем данные из строки табличной части в движение
		Движение = Движения.ОсновныеНачисления.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Строка); 
		// Ключевые периоды для регистра начислений:
    		// - ПериодРегистрации: начало месяца (для группировки начислений по месяцам)
   		// - ПериодДействия: фактические даты работы (для расчета пропорционально дням)
		Движение.ПериодРегистрации = ПериодРегистрации;
		Движение.ПериодДействияНачало = Строка.ДатаНачала;
		Движение.ПериодДействияКонец = КонецДня(Строка.ДатаОкончания);
	КонецЦикла;
	
	// Фиксируем движения в регистре
	Движения.ОсновныеНачисления.Записать();
	
	//Вызываем функцию из общего модуля для записи расчетов по основным начислениям.
	ЗаписьРасчетов.ЗаписатьОсновныеНачисления(Движения.ОсновныеНачисления, Ссылка);
	
	// ===== РЕГИСТРАЦИЯ ДОПОЛНИТЕЛЬНЫХ НАЧИСЛЕНИЙ =====
	// Дополнительные начисления (премии, надбавки) привязаны к целому месяцу,
	// так как рассчитываются от оклада за полный месяц работы
	Движения.ДополнительныеНачисления.Записывать = Истина;
	Для Каждого Строка Из ДополнительныеНачисления Цикл
		Движение = Движения.ДополнительныеНачисления.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Строка);
		// Для дополнительных начислений:
    		// - ПериодРегистрации: начало месяца (как у основных начислений)
    		// - БазовыйПериод: весь месяц (связь с основным начислением за месяц)
		Движение.ПериодРегистрации = ПериодРегистрации;
		Движение.БазовыйПериодНачало = ПериодРегистрации;
		Движение.БазовыйПериодКонец = КонецМесяца(ПериодРегистрации);
	КонецЦикла;
	
	// Фиксируем движения в регистре
	Движения.ДополнительныеНачисления.Записать();
	
	//Вызываем функцию из общего модуля для записи расчетов по дополнительным начислениям.
	ЗаписьРасчетов.ЗаписатьДополнительныеНачисления(Движения.ДополнительныеНачисления, Ссылка);
	
КонецПроцедуры
